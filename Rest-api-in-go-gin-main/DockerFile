# Build Stage
FROM golang:1.23-alpine AS builder

WORKDIR /app

# Install build dependencies
RUN apk add --no-cache gcc musl-dev

# Copy dependency files
COPY go.mod go.sum ./
RUN go mod download

# Copy source code
COPY . .

# Build the application (CGO enabled for SQLite)
RUN CGO_ENABLED=1 GOOS=linux go build -o main ./cmd/api

# Run Stage
FROM alpine:latest

WORKDIR /app

# Install runtime dependencies (sqlite)
RUN apk add --no-cache sqlite

# Copy binary from builder
COPY --from=builder /app/main .
# Copy migration files (crucial for setup)
COPY --from=builder /app/cmd/migrate/migrations ./cmd/migrate/migrations
# Copy empty db file if needed or let app create it
# COPY --from=builder /app/data.db . 

EXPOSE 8080

CMD ["./main"]
